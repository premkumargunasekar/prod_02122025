---
# roles/subnet_unit/tasks/main.yml
# Per-subnet processing executed on the target VM (Option A).
# Guarantees:
# - idempotent (checks by name)
# - only writes to Subnet.csv after GCP creation succeeds
# - rollback attempt on CSV append failure
# - retry on GCP creation

# 1) Find selected block from env_data
- name: Find selected block for Region+Env
  set_fact:
    selected_block: >-
      {{
        (env_data | selectattr('RegionCode','equalto', req.RegionCode)
                 | selectattr('Env','equalto', req.Env) | list)
        | first | default({}) | dict2items | selectattr('key','equalto','Block') | map(attribute='value') | list | first | default(omit)
      }}
  run_once: false

- name: Fail if block missing
  fail:
    msg: "No block found in Env.csv for Region={{ req.RegionCode }} Env={{ req.Env }}"
  when: selected_block is omitted

# 2) Determine naming counter and SubnetName
- name: Compute existing_count for naming
  set_fact:
    existing_count: >-
      {{
        (subnet_data | default([]))
        | selectattr('RegionCode','equalto', req.RegionCode)
        | selectattr('Env','equalto', req.Env)
        | list
        | length
      }}

- name: Build SubnetName and next_number
  set_fact:
    next_number: "{{ '%03d' % ((existing_count | int) + 1) }}"
    SubnetName: "{{ req.RegionCode | lower }}-{{ req.Env | lower }}-{{ req.Solution | lower }}-{{ next_number }}-snt"

# 3) Idempotency checks
- name: Check if subnet name already exists in CSV
  set_fact:
    already_exists_by_name: "{{ (subnet_data | default([])) | selectattr('SubnetName','equalto', SubnetName) | list | length > 0 }}"

- name: Early exit if already exists (by name)
  debug:
    msg: "Subnet already exists by name: {{ SubnetName }} â€” skipping creation."
  when: already_exists_by_name
  failed_when: false

- name: Calculate next available CIDR from block (runs on target)
  command:
    argv:
      - /usr/bin/python3
      - "{{ calc_script }}"
      - --block
      - "{{ selected_block }}"
      - --size
      - "{{ req.SubnetSize | string }}"
      - --subnet-csv
      - "{{ subnet_csv }}"
  register: calc
  changed_when: false

- name: Fail if no CIDR available
  fail:
    msg: "No available CIDR in block {{ selected_block }}"
  when: calc.stdout == ""

- name: Set new_cidr fact
  set_fact:
    new_cidr: "{{ calc.stdout }}"

- name: Validate proposed CIDR does not overlap existing (double-check)
  command:
    argv:
      - /usr/bin/python3
      - "{{ calc_script }}"
      - --validate
      - "{{ new_cidr }}"
      - --subnet-csv
      - "{{ subnet_csv }}"
  register: vcheck
  changed_when: false

- name: Fail if validation detects overlap
  fail:
    msg: "CIDR {{ new_cidr }} overlaps existing allocations according to validation"
  when: vcheck.stdout != "OK"

# 4) Create subnet in GCP (runs on target VM)
- name: Create subnet in GCP with retries (idempotent)
  block:
    - name: Create subnet (attempt block)
      google.cloud.gcp_compute_subnetwork:
        name: "{{ SubnetName }}"
        ip_cidr_range: "{{ new_cidr }}"
        region: "{{ region_map[req.RegionCode] }}"
        network:
          selfLink: "https://www.googleapis.com/compute/v1/projects/{{ gcp_project }}/global/networks/{{ req.VPC }}"
        project: "{{ gcp_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_sa_file }}"
        state: present
      register: gcp_result
      retries: 3
      delay: 5
      until: gcp_result is succeeded
  rescue:
    - name: Fail - GCP creation failed after retries
      fail:
        msg: "GCP subnet creation failed for {{ SubnetName }}: {{ gcp_result }}"

# 5) Append to Subnet.csv atomically (only after GCP success)
- name: Append to Subnet.csv atomically on target
  command:
    argv:
      - /usr/bin/python3
      - "{{ update_script }}"
      - --subnet-csv
      - "{{ subnet_csv }}"
      - --line
      - "{{ req.RegionCode }},{{ req.Env }},{{ new_cidr }},{{ SubnetName }},NetworkTeam,Created,{{ req.Comments | default('') }}"
  register: append_result
  changed_when: false

- name: Rollback if CSV append failed (attempt delete)
  when: append_result.rc != 0
  block:
    - name: Delete subnet due to CSV failure (cleanup)
      google.cloud.gcp_compute_subnetwork:
        name: "{{ SubnetName }}"
        region: "{{ region_map[req.RegionCode] }}"
        project: "{{ gcp_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_sa_file }}"
        state: absent
      register: cleanup_result
      ignore_errors: yes

    - name: Fail due to CSV write failure (include cleanup status)
      fail:
        msg: "Failed to append to Subnet.csv and attempted cleanup: {{ cleanup_result }}"

# 6) Add result to subnet_report (collected on host facts)
- name: Append result to subnet_report fact (on the host)
  set_fact:
    subnet_report: "{{ subnet_report + [ {
      'region_code': req.RegionCode,
      'region': region_map[req.RegionCode],
      'project': gcp_project,
      'vpc': req.VPC,
      'subnet_name': SubnetName,
      'cidr': new_cidr,
      'status': ( 'FAILED' if (append_result is defined and append_result.rc != 0) else 'SUCCESS' ),
      'message': ( append_result.stdout|default('CSV appended') if (append_result is defined and append_result.rc == 0) else (gcp_result.msg | default('GCP created') ) )
    } ] }}"
  run_once: false
